{
  "version": 1,
  "blocks": [
    { "type": "set-variable", "state": { "variable": "width", "value": "80" }, "children": [] },
    { "type": "set-variable", "state": { "variable": "height", "value": "60" }, "children": [] },
    { "type": "set-variable", "state": { "variable": "maxIter", "value": "40" }, "children": [] },
    { "type": "set-variable", "state": { "variable": "xmin", "value": "-2.5" }, "children": [] },
    { "type": "set-variable", "state": { "variable": "xmax", "value": "1" }, "children": [] },
    { "type": "set-variable", "state": { "variable": "ymin", "value": "-1.2" }, "children": [] },
    { "type": "set-variable", "state": { "variable": "ymax", "value": "1.2" }, "children": [] },

    {
      "type": "object-def",
      "state": { "name": "complex" },
      "children": [
        { "type": "function-def", "state": { "name": "add", "params": "a,b" }, "children": [
          { "type": "return", "state": { "value": "{ re: a.re + b.re, im: a.im + b.im }" }, "children": [] }
        ]},
        { "type": "function-def", "state": { "name": "mul", "params": "a,b" }, "children": [
          { "type": "return", "state": { "value": "{ re: a.re*b.re - a.im*b.im, im: a.re*b.im + a.im*b.re }" }, "children": [] }
        ]},
        { "type": "function-def", "state": { "name": "abs2", "params": "z" }, "children": [
          { "type": "return", "state": { "value": "z.re*z.re + z.im*z.im" }, "children": [] }
        ]}
      ]
    },

    { "type": "function-def", "state": { "name": "mandel", "params": "c,z,iter" }, "children": [
      { "type": "if", "state": { "condition": "complex.abs2(z) > 4 || iter >= maxIter" }, "children": [
        { "type": "return", "state": { "value": "iter" }, "children": [] }
      ]},
      { "type": "function-call", "state": { "name": "complex.mul", "args": "z, z", "target": "zz" }, "children": [] },
      { "type": "function-call", "state": { "name": "complex.add", "args": "zz, c", "target": "nextZ" }, "children": [] },
      { "type": "function-call", "state": { "name": "mandel", "args": "c, nextZ, iter + 1", "target": "iterNext" }, "children": [] },
      { "type": "return", "state": { "value": "iterNext" }, "children": [] }
    ]},

    {
      "type": "for-range",
      "state": { "variable": "px", "from": "0", "to": "width" },
      "children": [
        {
          "type": "for-range",
          "state": { "variable": "py", "from": "0", "to": "height" },
          "children": [
            { "type": "object-literal", "state": {
                "target": "c",
                "pairs": "re: xmin + (px / width) * (xmax - xmin), im: ymin + (py / height) * (ymax - ymin)"
            }, "children": [] },
            { "type": "object-literal", "state": { "target": "z", "pairs": "re:0, im:0" }, "children": [] },
            { "type": "function-call", "state": { "name": "mandel", "args": "c, z, 0", "target": "iter" }, "children": [] },
            { "type": "set-variable", "state": { "variable": "shade", "value": "iter / maxIter" }, "children": [] },
            { "type": "plot-pixel", "state": {
                "x": "px",
                "y": "py",
                "color": "`#${(255*shade|0).toString(16).padStart(2,\"0\")}00${(255*(1-shade)|0).toString(16).padStart(2,\"0\")}`"
            }, "children": [] }
          ]
        }
      ]
    }
  ]
}
